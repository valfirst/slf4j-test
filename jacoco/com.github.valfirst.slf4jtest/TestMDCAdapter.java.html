<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestMDCAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SLF4J Test</a> &gt; <a href="index.source.html" class="el_package">com.github.valfirst.slf4jtest</a> &gt; <span class="el_source">TestMDCAdapter.java</span></div><h1>TestMDCAdapter.java</h1><pre class="source lang-java linenums">package com.github.valfirst.slf4jtest;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.TreeMap;
import org.slf4j.MDC;
import org.slf4j.helpers.BasicMDCAdapter;

public class TestMDCAdapter extends BasicMDCAdapter {

    private final ThreadLocal&lt;Map&lt;String, String&gt;&gt; value;
    private final boolean initialEnable;
    private final boolean initialInherit;
    private final boolean initialReturnNullCopyWhenMdcNotSet;
    private final boolean initialAllowNullValues;
    private volatile boolean enable;
    private volatile boolean inherit;
    private volatile boolean returnNullCopyWhenMdcNotSet;
    private volatile boolean allowNullValues;

    public TestMDCAdapter() {
<span class="fc" id="L24">        this(OverridableProperties.createUnchecked(&quot;slf4jtest&quot;));</span>
<span class="fc" id="L25">    }</span>

<span class="fc" id="L27">    TestMDCAdapter(OverridableProperties properties) {</span>
<span class="fc" id="L28">        enable = initialEnable = getBooleanProperty(properties, &quot;mdc.enable&quot;, true);</span>
<span class="fc" id="L29">        inherit = initialInherit = getBooleanProperty(properties, &quot;mdc.inherit&quot;, false);</span>
<span class="fc" id="L30">        returnNullCopyWhenMdcNotSet =</span>
                initialReturnNullCopyWhenMdcNotSet =
<span class="fc" id="L32">                        getBooleanProperty(properties, &quot;mdc.return.null.copy.when.mdc.not.set&quot;, false);</span>
<span class="fc" id="L33">        allowNullValues =</span>
<span class="fc" id="L34">                initialAllowNullValues = getBooleanProperty(properties, &quot;mdc.allow.null.values&quot;, true);</span>

<span class="fc" id="L36">        value =</span>
<span class="fc" id="L37">                new InheritableThreadLocal&lt;Map&lt;String, String&gt;&gt;() {</span>
                    @Override
                    protected Map&lt;String, String&gt; childValue(Map&lt;String, String&gt; parentValue) {
<span class="pc bpc" id="L40" title="2 of 6 branches missed.">                        if (enable &amp;&amp; inherit &amp;&amp; parentValue != null) {</span>
<span class="fc" id="L41">                            return new HashMap&lt;&gt;(parentValue);</span>
                        } else {
<span class="fc" id="L43">                            return null;</span>
                        }
                    }
                };
<span class="fc" id="L47">    }</span>

    static boolean getBooleanProperty(
            OverridableProperties properties, String propertyKey, boolean defaultValue) {
<span class="fc" id="L51">        return Boolean.parseBoolean(properties.getProperty(propertyKey, String.valueOf(defaultValue)));</span>
    }

    @Override
    public void put(final String key, final String val) {
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L57">            return;</span>
        }
<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (key == null) {</span>
<span class="fc" id="L60">            throw new IllegalArgumentException(&quot;key cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L62" title="All 4 branches covered.">        if (val == null &amp;&amp; !allowNullValues) {</span>
<span class="fc" id="L63">            throw new IllegalArgumentException(&quot;val cannot be null&quot;);</span>
        }
<span class="fc" id="L65">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (map == null) {</span>
<span class="fc" id="L67">            map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L68">            value.set(map);</span>
        }
<span class="fc" id="L70">        map.put(key, val);</span>
<span class="fc" id="L71">    }</span>

    @Override
    public String get(final String key) {
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L76">            return null;</span>
        }
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (key == null) {</span>
<span class="fc" id="L79">            throw new IllegalArgumentException(&quot;key cannot be null&quot;);</span>
        }
<span class="fc" id="L81">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (map != null) {</span>
<span class="fc" id="L83">            return map.get(key);</span>
        } else {
<span class="fc" id="L85">            return null;</span>
        }
    }

    @Override
    public void remove(final String key) {
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L92">            return;</span>
        }
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if (key == null) {</span>
<span class="fc" id="L95">            throw new IllegalArgumentException(&quot;key cannot be null&quot;);</span>
        }
<span class="fc" id="L97">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (map != null) {</span>
<span class="fc" id="L99">            map.remove(key);</span>
        }
<span class="fc" id="L101">    }</span>

    @Override
    public void clear() {
<span class="fc bfc" id="L105" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L106">            return;</span>
        }
<span class="fc" id="L108">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (map == null) {</span>
<span class="fc" id="L110">            return;</span>
        }
<span class="fc" id="L112">        map.clear();</span>
<span class="fc" id="L113">        value.remove();</span>
<span class="fc" id="L114">    }</span>

    /**
     * Return a copy of the current thread's context map. {@code null} is returned if
     *
     * &lt;ul&gt;
     *   &lt;li&gt;The MDC functionality is disabled, c.f. &lt;code&gt;setEnable&lt;/code&gt;, or
     *   &lt;li&gt;&quot;return null when empty&quot; is enabled, c.f. &lt;code&gt;setReturnNullCopyWhenMdcNotSet&lt;/code&gt;,
     *       and &lt;code&gt;put&lt;/code&gt; has not been called.
     * &lt;/ul&gt;
     *
     * @return A copy of the current thread's context map.
     */
    @Override
    public Map&lt;String, String&gt; getCopyOfContextMap() {
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L130">            return null;</span>
        }
<span class="fc" id="L132">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (map == null) {</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">            if (returnNullCopyWhenMdcNotSet) {</span>
<span class="fc" id="L135">                return null;</span>
            } else {
<span class="fc" id="L137">                return new TreeMap&lt;&gt;();</span>
            }
        } else {
<span class="fc" id="L140">            return new TreeMap&lt;&gt;(map);</span>
        }
    }

    // Internal access
    Map&lt;String, String&gt; getContextMap() {
<span class="fc" id="L146">        Map&lt;String, String&gt; map = value.get();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">        return map == null ? Collections.emptySortedMap() : map;</span>
    }

    @Override
    public void setContextMap(final Map&lt;String, String&gt; contextMap) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (!enable) {</span>
<span class="fc" id="L153">            return;</span>
        }
<span class="fc" id="L155">        clear();</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (contextMap == null) {</span>
<span class="fc" id="L157">            return;</span>
        }
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (contextMap.keySet().stream().anyMatch(Objects::isNull)) {</span>
<span class="fc" id="L160">            throw new IllegalArgumentException(&quot;key cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L162" title="All 4 branches covered.">        if (!allowNullValues &amp;&amp; contextMap.containsValue(null)) {</span>
<span class="fc" id="L163">            throw new IllegalArgumentException(&quot;val cannot be null&quot;);</span>
        }
<span class="fc" id="L165">        value.set(new HashMap&lt;&gt;(contextMap));</span>
<span class="fc" id="L166">    }</span>

    /**
     * Enable the MDC functionality for all threads.
     *
     * @param enable Whether to enable the MDC functionality. The default value is {@code true}.
     */
    public void setEnable(boolean enable) {
<span class="fc" id="L174">        this.enable = enable;</span>
<span class="fc" id="L175">    }</span>

    /**
     * Define whether child threads inherit a copy of the MDC from its parent thread. Note that the
     * copy is taken when the {@link Thread} is constructed. This affects all threads.
     *
     * @param inherit Whether to enable inheritance. The default value is {@code false}.
     */
    public void setInherit(boolean inherit) {
<span class="fc" id="L184">        this.inherit = inherit;</span>
<span class="fc" id="L185">    }</span>

    /**
     * Define whether null values are allowed in the MDC. This affects all threads.
     *
     * @param allowNullValues Whether to allow nulls. The default value is {@code true}.
     */
    public void setAllowNullValues(boolean allowNullValues) {
<span class="fc" id="L193">        this.allowNullValues = allowNullValues;</span>
<span class="fc" id="L194">    }</span>

    /**
     * Define whether {@link #getCopyOfContextMap} returns {@code null} when no values have been set.
     * This affects all threads.
     *
     * @param returnNullCopyWhenMdcNotSet Whether to return null. The default value is {@code false}.
     *     If {@code false}, an empty map is returned instead.
     */
    public void setReturnNullCopyWhenMdcNotSet(boolean returnNullCopyWhenMdcNotSet) {
<span class="fc" id="L204">        this.returnNullCopyWhenMdcNotSet = returnNullCopyWhenMdcNotSet;</span>
<span class="fc" id="L205">    }</span>

    /**
     * Whether the MDC functionality is enabled.
     *
     * @return Whether the MDC functionality is enabled.
     */
    public boolean getEnable() {
<span class="fc" id="L213">        return enable;</span>
    }

    /**
     * Whether child threads inherit a copy of the MDC from its parent thread.
     *
     * @return Whether inheritance is enabled.
     */
    public boolean getInherit() {
<span class="fc" id="L222">        return inherit;</span>
    }

    /**
     * Whether null values are allowed in the MDC.
     *
     * @return Whether nulls are allowed.
     */
    public boolean getAllowNullValues() {
<span class="fc" id="L231">        return allowNullValues;</span>
    }

    /**
     * Whether {@link #getCopyOfContextMap} returns {@code null} when no values have been set.
     *
     * @return Whether to return null.
     */
    public boolean getReturnNullCopyWhenMdcNotSet() {
<span class="fc" id="L240">        return returnNullCopyWhenMdcNotSet;</span>
    }

    /**
     * Reset the options to values defined by the static configuration. This undoes to changes made
     * using {@link #setEnable}, {@link #setInherit}, {@link #setAllowNullValues}, and {@link
     * #setReturnNullCopyWhenMdcNotSet}.
     */
    public void restoreOptions() {
<span class="fc" id="L249">        enable = initialEnable;</span>
<span class="fc" id="L250">        inherit = initialInherit;</span>
<span class="fc" id="L251">        returnNullCopyWhenMdcNotSet = initialReturnNullCopyWhenMdcNotSet;</span>
<span class="fc" id="L252">        allowNullValues = initialAllowNullValues;</span>
<span class="fc" id="L253">    }</span>

    /** Access the current MDC adapter. Used to call the option setting methods. */
    @SuppressWarnings(&quot;unchecked&quot;)
    public static TestMDCAdapter getInstance() {
<span class="fc" id="L258">        return (TestMDCAdapter) MDC.getMDCAdapter();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>