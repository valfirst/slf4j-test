<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoggingEvent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SLF4J Test</a> &gt; <a href="index.source.html" class="el_package">com.github.valfirst.slf4jtest</a> &gt; <span class="el_source">LoggingEvent.java</span></div><h1>LoggingEvent.java</h1><pre class="source lang-java linenums">package com.github.valfirst.slf4jtest;

import static com.google.common.base.Preconditions.checkNotNull;
import static java.util.Optional.empty;
import static java.util.Optional.ofNullable;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import java.io.PrintStream;
import java.util.Arrays;
import java.util.Collections;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;
import org.joda.time.Instant;
import org.slf4j.Marker;
import org.slf4j.helpers.MessageFormatter;
import uk.org.lidalia.slf4jext.Level;

/**
 * Representation of a call to a logger for test assertion purposes. The contract of {@link
 * #equals(Object)} and {@link #hashCode} is that they compare the results of:
 *
 * &lt;ul&gt;
 *   &lt;li&gt;{@link #getLevel()}
 *   &lt;li&gt;{@link #getMdc()}
 *   &lt;li&gt;{@link #getMarker()}
 *   &lt;li&gt;{@link #getThrowable()}
 *   &lt;li&gt;{@link #getMessage()}
 *   &lt;li&gt;{@link #getArguments()}
 * &lt;/ul&gt;
 *
 * &lt;p&gt;They do NOT compare the results of {@link #getTimestamp()}, {@link #getCreatingLogger()} or
 * {@link #getThreadContextClassLoader()} as this would render it impractical to create appropriate
 * expected {@link LoggingEvent}s to compare against.
 *
 * &lt;p&gt;Constructors and convenient static factory methods exist to create {@link LoggingEvent}s with
 * appropriate defaults. These are not documented further as they should be self-evident.
 */
@SuppressWarnings({&quot;PMD.ExcessivePublicCount&quot;, &quot;PMD.TooManyMethods&quot;})
public class LoggingEvent {

    private final Level level;
    private final ImmutableMap&lt;String, String&gt; mdc;
    private final Optional&lt;Marker&gt; marker;
    private final Optional&lt;Throwable&gt; throwable;
    private final String message;
    private final ImmutableList&lt;Object&gt; arguments;

    private final Optional&lt;TestLogger&gt; creatingLogger;
<span class="fc" id="L52">    private final Instant timestamp = new Instant();</span>
<span class="fc" id="L53">    private final String threadName = Thread.currentThread().getName();</span>
<span class="fc" id="L54">    private final ClassLoader threadContextClassLoader =</span>
<span class="fc" id="L55">            Thread.currentThread().getContextClassLoader();</span>

    public static LoggingEvent trace(final String message, final Object... arguments) {
<span class="fc" id="L58">        return new LoggingEvent(Level.TRACE, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Throwable throwable, final String message, final Object... arguments) {
<span class="fc" id="L63">        return new LoggingEvent(Level.TRACE, throwable, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L68">        return new LoggingEvent(Level.TRACE, marker, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L76">        return new LoggingEvent(Level.TRACE, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Map&lt;String, String&gt; mdc, final String message, final Object... arguments) {
<span class="fc" id="L81">        return new LoggingEvent(Level.TRACE, mdc, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L89">        return new LoggingEvent(Level.TRACE, mdc, throwable, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L97">        return new LoggingEvent(Level.TRACE, mdc, marker, message, arguments);</span>
    }

    public static LoggingEvent trace(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L106">        return new LoggingEvent(Level.TRACE, mdc, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent debug(final String message, final Object... arguments) {
<span class="fc" id="L110">        return new LoggingEvent(Level.DEBUG, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Throwable throwable, final String message, final Object... arguments) {
<span class="fc" id="L115">        return new LoggingEvent(Level.DEBUG, throwable, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L120">        return new LoggingEvent(Level.DEBUG, marker, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L128">        return new LoggingEvent(Level.DEBUG, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Map&lt;String, String&gt; mdc, final String message, final Object... arguments) {
<span class="fc" id="L133">        return new LoggingEvent(Level.DEBUG, mdc, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L141">        return new LoggingEvent(Level.DEBUG, mdc, throwable, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L149">        return new LoggingEvent(Level.DEBUG, mdc, marker, message, arguments);</span>
    }

    public static LoggingEvent debug(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L158">        return new LoggingEvent(Level.DEBUG, mdc, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent info(final String message, final Object... arguments) {
<span class="fc" id="L162">        return new LoggingEvent(Level.INFO, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Throwable throwable, final String message, final Object... arguments) {
<span class="fc" id="L167">        return new LoggingEvent(Level.INFO, throwable, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L172">        return new LoggingEvent(Level.INFO, marker, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L180">        return new LoggingEvent(Level.INFO, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Map&lt;String, String&gt; mdc, final String message, final Object... arguments) {
<span class="fc" id="L185">        return new LoggingEvent(Level.INFO, mdc, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L193">        return new LoggingEvent(Level.INFO, mdc, throwable, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L201">        return new LoggingEvent(Level.INFO, mdc, marker, message, arguments);</span>
    }

    public static LoggingEvent info(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L210">        return new LoggingEvent(Level.INFO, mdc, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent warn(final String message, final Object... arguments) {
<span class="fc" id="L214">        return new LoggingEvent(Level.WARN, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Throwable throwable, final String message, final Object... arguments) {
<span class="fc" id="L219">        return new LoggingEvent(Level.WARN, throwable, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L224">        return new LoggingEvent(Level.WARN, marker, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L232">        return new LoggingEvent(Level.WARN, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Map&lt;String, String&gt; mdc, final String message, final Object... arguments) {
<span class="fc" id="L237">        return new LoggingEvent(Level.WARN, mdc, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L245">        return new LoggingEvent(Level.WARN, mdc, throwable, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L253">        return new LoggingEvent(Level.WARN, mdc, marker, message, arguments);</span>
    }

    public static LoggingEvent warn(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L262">        return new LoggingEvent(Level.WARN, mdc, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent error(final String message, final Object... arguments) {
<span class="fc" id="L266">        return new LoggingEvent(Level.ERROR, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Throwable throwable, final String message, final Object... arguments) {
<span class="fc" id="L271">        return new LoggingEvent(Level.ERROR, throwable, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L276">        return new LoggingEvent(Level.ERROR, marker, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L284">        return new LoggingEvent(Level.ERROR, marker, throwable, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Map&lt;String, String&gt; mdc, final String message, final Object... arguments) {
<span class="fc" id="L289">        return new LoggingEvent(Level.ERROR, mdc, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L297">        return new LoggingEvent(Level.ERROR, mdc, throwable, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L305">        return new LoggingEvent(Level.ERROR, mdc, marker, message, arguments);</span>
    }

    public static LoggingEvent error(
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L314">        return new LoggingEvent(Level.ERROR, mdc, marker, throwable, message, arguments);</span>
    }

    public LoggingEvent(final Level level, final String message, final Object... arguments) {
<span class="fc" id="L318">        this(level, Collections.emptyMap(), empty(), empty(), message, arguments);</span>
<span class="fc" id="L319">    }</span>

    public LoggingEvent(
            final Level level,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L326">        this(level, Collections.emptyMap(), empty(), ofNullable(throwable), message, arguments);</span>
<span class="fc" id="L327">    }</span>

    public LoggingEvent(
            final Level level, final Marker marker, final String message, final Object... arguments) {
<span class="fc" id="L331">        this(level, Collections.emptyMap(), ofNullable(marker), empty(), message, arguments);</span>
<span class="fc" id="L332">    }</span>

    public LoggingEvent(
            final Level level,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L340">        this(</span>
                level,
<span class="fc" id="L342">                Collections.emptyMap(),</span>
<span class="fc" id="L343">                ofNullable(marker),</span>
<span class="fc" id="L344">                ofNullable(throwable),</span>
                message,
                arguments);
<span class="fc" id="L347">    }</span>

    public LoggingEvent(
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final String message,
            final Object... arguments) {
<span class="fc" id="L354">        this(level, mdc, empty(), empty(), message, arguments);</span>
<span class="fc" id="L355">    }</span>

    public LoggingEvent(
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L363">        this(level, mdc, empty(), ofNullable(throwable), message, arguments);</span>
<span class="fc" id="L364">    }</span>

    public LoggingEvent(
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final String message,
            final Object... arguments) {
<span class="fc" id="L372">        this(level, mdc, ofNullable(marker), empty(), message, arguments);</span>
<span class="fc" id="L373">    }</span>

    public LoggingEvent(
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final Marker marker,
            final Throwable throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L382">        this(level, mdc, ofNullable(marker), ofNullable(throwable), message, arguments);</span>
<span class="fc" id="L383">    }</span>

    private LoggingEvent(
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final Optional&lt;Marker&gt; marker,
            final Optional&lt;Throwable&gt; throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L392">        this(empty(), level, mdc, marker, throwable, message, arguments);</span>
<span class="fc" id="L393">    }</span>

    LoggingEvent(
            final Optional&lt;TestLogger&gt; creatingLogger,
            final Level level,
            final Map&lt;String, String&gt; mdc,
            final Optional&lt;Marker&gt; marker,
            final Optional&lt;Throwable&gt; throwable,
            final String message,
            final Object... arguments) {
<span class="fc" id="L403">        super();</span>
<span class="fc" id="L404">        this.creatingLogger = creatingLogger;</span>
<span class="fc" id="L405">        this.level = checkNotNull(level);</span>
<span class="fc" id="L406">        this.mdc = ImmutableMap.copyOf(mdc);</span>
<span class="fc" id="L407">        this.marker = checkNotNull(marker);</span>
<span class="fc" id="L408">        this.throwable = checkNotNull(throwable);</span>
<span class="fc" id="L409">        this.message = checkNotNull(message);</span>
<span class="fc" id="L410">        this.arguments =</span>
<span class="fc" id="L411">                ImmutableList.copyOf(</span>
<span class="fc" id="L412">                        Arrays.stream(arguments)</span>
<span class="fc" id="L413">                                .map(input -&gt; ofNullable(input).orElse(empty()))</span>
<span class="fc" id="L414">                                .collect(Collectors.toList()));</span>
<span class="fc" id="L415">    }</span>

    public Level getLevel() {
<span class="fc" id="L418">        return level;</span>
    }

    public ImmutableMap&lt;String, String&gt; getMdc() {
<span class="fc" id="L422">        return mdc;</span>
    }

    public Optional&lt;Marker&gt; getMarker() {
<span class="fc" id="L426">        return marker;</span>
    }

    public String getMessage() {
<span class="fc" id="L430">        return message;</span>
    }

    public ImmutableList&lt;Object&gt; getArguments() {
<span class="fc" id="L434">        return arguments;</span>
    }

    public Optional&lt;Throwable&gt; getThrowable() {
<span class="fc" id="L438">        return throwable;</span>
    }

    /**
     * @return the logger that created this logging event.
     * @throws IllegalStateException if this logging event was not created by a logger
     */
    public TestLogger getCreatingLogger() {
<span class="fc" id="L446">        return creatingLogger.get();</span>
    }

    /** @return the time at which this logging event was created */
    public Instant getTimestamp() {
<span class="fc" id="L451">        return timestamp;</span>
    }

    /** @return the name of the thread that created this logging event */
    public String getThreadName() {
<span class="fc" id="L456">        return threadName;</span>
    }

    /** @return the Thread Context Classloader used when this logging event was created */
    public ClassLoader getThreadContextClassLoader() {
<span class="fc" id="L461">        return threadContextClassLoader;</span>
    }

    void print() {
<span class="fc" id="L465">        final PrintStream output = printStreamForLevel();</span>
<span class="fc" id="L466">        output.println(formatLogStatement());</span>
<span class="fc" id="L467">        throwable.ifPresent(throwableToPrint -&gt; throwableToPrint.printStackTrace(output));</span>
<span class="fc" id="L468">    }</span>

    private String formatLogStatement() {
<span class="fc" id="L471">        return getTimestamp()</span>
                + &quot; [&quot;
<span class="fc" id="L473">                + getThreadName()</span>
                + &quot;] &quot;
<span class="fc" id="L475">                + getLevel()</span>
<span class="fc" id="L476">                + safeLoggerName()</span>
                + &quot; - &quot;
<span class="fc" id="L478">                + getFormattedMessage();</span>
    }

    private String safeLoggerName() {
<span class="fc" id="L482">        return creatingLogger.map(logger -&gt; &quot; &quot; + logger.getName()).orElse(&quot;&quot;);</span>
    }

    public String getFormattedMessage() {
<span class="fc" id="L486">        Object[] argumentsWithNulls =</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">                getArguments().stream().map(a -&gt; a.equals(Optional.empty()) ? null : a).toArray();</span>
<span class="fc" id="L488">        return MessageFormatter.arrayFormat(getMessage(), argumentsWithNulls).getMessage();</span>
    }

    private PrintStream printStreamForLevel() {
<span class="fc bfc" id="L492" title="All 2 branches covered.">        switch (level) {</span>
            case ERROR:
            case WARN:
<span class="fc" id="L495">                return System.err;</span>
            default:
<span class="fc" id="L497">                return System.out;</span>
        }
    }

    @Override
    public boolean equals(Object o) {
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L504">            return true;</span>
        }
<span class="pc bpc" id="L506" title="2 of 4 branches missed.">        if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L507">            return false;</span>
        }
<span class="fc" id="L509">        LoggingEvent that = (LoggingEvent) o;</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">        return level == that.level</span>
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(mdc, that.mdc)</span>
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(marker, that.marker)</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">                &amp;&amp; Objects.equals(throwable, that.throwable)</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">                &amp;&amp; Objects.equals(message, that.message)</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">                &amp;&amp; Objects.equals(arguments, that.arguments);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L520">        return Objects.hash(level, mdc, marker, throwable, message, arguments);</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L525">        return &quot;LoggingEvent{&quot;</span>
                + &quot;level=&quot;
                + level
                + &quot;, mdc=&quot;
                + mdc
                + &quot;, marker=&quot;
                + marker
                + &quot;, throwable=&quot;
                + throwable
                + &quot;, message='&quot;
                + message
                + '\''
                + &quot;, arguments=&quot;
                + arguments
                + '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>